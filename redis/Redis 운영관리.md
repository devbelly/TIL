 <p align="center">
	<img width="418" alt="image" src="https://github.com/devbelly/TIL/assets/67682840/d05ceae7-f3e9-49a4-8566-4d3df5c922d4">
</p>

# 1. Redis 이해

## 1.1 Redis란 무엇인가?

- 캐시솔루션
- NoSQL의 Key-Value 스토어

## 1.2 Redis의 주요특성

- Key-Value 스토어
- 컬렉션지원
	- 일반적으로 사용하는 컬렉션은 멀티쓰레드 환경에서 동시성 문제가 발생할 수 있다.
	- 레디스를 이용하면 분산환경에서 컬렉션을 처리할 수 있다.
- Pub/Sub 지원
- 디스크 저장
	- 인메모리 DB가 가지는 특징으로 인해 휘발성 문제를 극복해야한다. 이를 위해 RDB,AOF를 사용해 디스크에 저장할 수 있다.
	- RDB
		- 현재 메모리의 상태를 디스크에 남기는 기능
	 - AOF
		 - 업데이트 관련 명령을 로그파일로 저장한다.
		 - RDB에 비해 생성되는 파일이 크기 때문에 속도가 느린편이다.
		 - 파일 사이즈가 커지면 rewrite 과정을 통해 파일 크기를 줄인다.
 - 복제기능
	 - master / slave 구조의 레플리카를 지원한다.
- 빠른 속도

# 2장. Redis 운영과 관리

## 2.1 레디스는 싱글 스레드이다.

- 위 특성을 제대로 파악하지 못하거나 이해를 못해 장애가 발생하는 경우가 잦다.
- 싱글 스레드이므로 하나의 명령이 시간이 오래 걸린다면 다른 명령을 처리하는데도 시간이 오래걸린다.

### 2.1.1 서버에서는 keys 명령을 사용하지 말자.

- Redis 메뉴얼에서는 keys 명령어를 프로덕션 환경에서 사용하지 말라고 언급한다.

### 2.1.2 flushall/flushdb 명령을 주의하자.

- 레디스는 db라는 가상공간으로 분리하여 관리한다.
- flushdb는 하나의 db를 날리고 flushall은 모든 db를 날린다.
- memcached와 달리 레디스의 flushall은 O(N)으로 모든 키와 값을 삭제한다.
	- memcached는 실제로 데이터를 날리는 것이 아니라 flushall 명령을 수행하면 날짜를 설정하는데 해당 날짜 이후로 기록된 키만 검색하는 방식으로 구현했다.

## 2.2 Redis Persistent

- memcached와 비교되는 가장 큰 특징 중 하나이다.

### 2.2.1 RDB

- RDB는 현재 메모리에 있는 내용을 파일로 저장한다. 확장자명이 `.rdb`이다.
- 두가지 방식이 있다.
	- SAVE
		- 실행을 멈추고 현재까지 메모리에 있는 내용을 파일에 저장한다.
	- BGSAVE
		- fork로 자식 프로세스를 생성한 후 자식 프로세스에 있는 메모리 내용을 저장한다.
		- BackGround에서 실행되므로 부모 프로세스를 멈추지 않는다.

### 2.2.2 AOF

- 데이터를 메모리에 반영하기 전에 AOF 파일에 기록한다.
- AOF시 실행 순서
	- 1. 클라이언트가 레디스에 업데이트 관련 명령 요청
	- 2. AOF 파일에 레디스 프로토콜 형식으로 기록
	- 3. 실제로 해당 명령을 실행해서 메모리에 명령내용 반영

> [!info] RDB와 AOF 둘다 존재 한다면 AOF파일이 최신 내용을 반영하고 있다고 생각하기 때문에 우선적으로 AOF를 메모리에 반영한다.

> [!info] RDB는 AOF보다 비교적 작은 파일로 기록하기 때문에 로딩속도가 빠르다는 장점이 있다. 만약 스냅샷을 찍기전에 RDB로 기록하지 못한다면 해당 내용을 복구할 수 없다.

- `appendfsync`는 `no`, `everysec`, `always`가 있으며 버퍼 캐시에 있는 파일을 얼마나 자주 디스크에 쓸지 결정하는 것이다.
	- 작성된 순서대로 빠르다

### 2.2.3 Redis가 메모리를 두 배로 사용하는 문제

- 레디스 운영중 가장 큰 문제를 일으키는 것은 메모리 문제이다.
- BGSAVE과정에서 자식 프로세스를 만들게 되면 메모리 부족 문제가 발생한다.

> [!info] fork와 메모리
> - 예전에는 부모의 메모리를 그대로 자식 프로세스의 메모리로 옮겼다.
> - 기술이 발전함에 따라 COW(copy on write)이 생겼다. 
> - fork시 메모리를 공유하지만 메모리의 변경이 있는 부분만 차후에 자식의 메모리로 가져와서 사용한다.
> - 레디스는 write 연산이 많이 일어나므로 cow 기술과 상관없이 거의 두배의 메모리를 사용하게 되므로 메모리가 부족해진다.

### 2.2.4 Redis의 장애 : Read는 성공하지만 Write는 실패하는 경우

- 레디스가 RDB 저장에 실패할 때 정상적인 상황이 아니라고 판단. Read는 성공하지만 Write관련 요청은 거절된다.
	- `lastbgsave_status` 변수가 `REDIS_ERR`로 설정된다.
	- Read는 가능하므로 heartbeat에는 이상이 없다고 나온다.
- RDB 저장이 실패하는 경우?
	- 디스크 공간 부족
	- 메모리 부족으로 인해 자식 프로세스가 생성되지 못함
	- 누군가가 자식 프로세스를 종료